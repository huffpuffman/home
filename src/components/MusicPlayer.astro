---
const track = "/audio/fear-tyler-huffman.wav";
---

<div class="w-full max-w-4xl mx-auto bg-primary border border-gold rounded-2xl shadow-mystic p-6 text-center">
  <h3 class="text-gold font-heading text-2xl mb-4">Fear of God</h3>

  <canvas id="waveform" class="w-full h-32 rounded-xl mb-4 bg-secondary"></canvas>
  <audio id="audio" src={track} preload="auto" class="hidden"></audio>

  <button
    onclick="toggleAudio()"
    class="mt-2 px-6 py-2 bg-gold text-primary font-semibold rounded-xl shadow hover:bg-yellow-300 transition"
  >
    Play / Pause
  </button>
</div>

<script>
  /** @type {AudioContext | undefined} */
  let audioCtx;
  /** @type {HTMLAudioElement | null} */
  let audioElement;
  /** @type {AnalyserNode | undefined} */
  let analyser;
  /** @type {Uint8Array | undefined} */
  let dataArray;
  /** @type {HTMLCanvasElement | null} */
  let canvas;
  /** @type {CanvasRenderingContext2D | null} */
  let canvasCtx;
  /** @type {number | undefined} */
  let animationId;

  function setupAudio() {
    audioElement = document.getElementById("audio");
    canvas = document.getElementById("waveform");

    if (!audioElement || !canvas) return;

    canvasCtx = canvas.getContext("2d");

    if (!canvasCtx) return;

    audioCtx = new (window.AudioContext)();
    const source = audioCtx.createMediaElementSource(audioElement);
    analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    analyser.fftSize = 1024;
    const bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    draw();
  }

  function draw() {
    if (!canvas || !canvasCtx || !analyser || !dataArray) return;

    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;

    animationId = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(dataArray);

    canvasCtx.fillStyle = "#081448";
    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

    canvasCtx.lineWidth = 2;
    canvasCtx.strokeStyle = "#fdbe01";
    canvasCtx.beginPath();

    const sliceWidth = WIDTH / dataArray.length;
    let x = 0;

    for (let i = 0; i < dataArray.length; i++) {
      const v = dataArray[i] / 128.0;
      const y = (v * HEIGHT) / 2;

      i === 0 ? canvasCtx.moveTo(x, y) : canvasCtx.lineTo(x, y);
      x += sliceWidth;
    }

    canvasCtx.lineTo(WIDTH, HEIGHT / 2);
    canvasCtx.stroke();
  }

  function toggleAudio() {
    if (!audioElement || !audioCtx) return;

    if (audioElement.paused) {
      audioCtx.resume();
      audioElement.play();
    } else {
      audioElement.pause();
    }
  }

  window.addEventListener("DOMContentLoaded", () => {
    setupAudio();
  });
</script>





<!-- Old Player -->
<!-- <script type="module">
  let audio;
  let isPlaying = false;

  function togglePlayback() {
    if (!audio) return;

    if (audio.paused) {
      audio.play();
      isPlaying = true;
    } else {
      audio.pause();
      isPlaying = false;
    }
  }
</script>

<div class="w-full max-w-3xl mx-auto bg-primary border border-gold rounded-2xl shadow-mystic p-6 text-center relative">
  <h3 class="text-gold font-heading text-2xl mb-4">Fear of God</h3>

  <audio id="audioPlayer" bind:this={audio} src={track} preload="auto" class="w-full mt-4"></audio>

  <button
    on:click={togglePlayback}
    class="mt-2 px-6 py-2 bg-gold text-primary font-semibold rounded-xl shadow hover:bg-yellow-300 transition"
  >
    {isPlaying ? 'Pause' : 'Play'}
  </button>
</div> -->





<!-- SoundCloud Player ---
const { trackUrl = "https://api.soundcloud.com/tracks/95758286" } = Astro.props;
const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(trackUrl)}&color=%23fdbe01&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=true`;
---

<div class="rounded-2xl overflow-hidden shadow-mystic border border-gold max-w-3xl mx-auto">
  <iframe
    width="100%"
    height="166"
    scrolling="no"
    frameborder="no"
    allow="autoplay"
    src={embedUrl}
    class="h-[300px] md:h-[400px] w-full">
  </iframe>
</div> -->



<!-- <iframe width="100%" height="300" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/95758286&color=%23fdbe01&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true"></iframe><div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;"><a href="https://soundcloud.com/tylerhuffman" title="tylerhuffman" target="_blank" style="color: #cccccc; text-decoration: none;">tylerhuffman</a> Â· <a href="https://soundcloud.com/tylerhuffman/mantra-intro" title="Mantra (Intro)" target="_blank" style="color: #cccccc; text-decoration: none;">Mantra (Intro)</a></div> -->
